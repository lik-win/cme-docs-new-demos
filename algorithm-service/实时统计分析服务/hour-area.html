<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>小时区域统计</title>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #Echart {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="Echart"></div>
    <script type="text/javascript" src="/libs/echarts.min.js"></script>
    <script type="text/javascript" src="/libs/dayjs.min.js"></script>
    <script type="text/javascript">
      let chart = null,
        option = {}
      const apiInfo = {
        url: 'http://10.40.88.119:11000/cmes-base-gbase/cmes_gbase/inte/mergeRegionAreaHour',
        args: {
          areaCode: {
            value: '110000',
            type: 'string',
            required: true,
            desc: '行政编码',
          },
          areaName: {
            value: '北京',
            type: 'string',
            required: true,
            desc: '地区名称',
          },
          elementMark: {
            value: ['avgPre'],
            type: 'array',
            required: true,
            desc: '查询类型',
          },
          startTime: {
            value: '2024-07-01 09:00:00',
            type: 'string',
            required: true,
            desc: '开始时间',
          },
          endTime: {
            value: '2024-07-10 09:00:00',
            type: 'string',
            required: true,
            desc: '结束时间',
          },
          page: {
            value: 1,
            type: 'number',
            required: true,
            desc: '页码',
          },
          size: {
            value: 50,
            type: 'number',
            required: true,
            desc: '分页大小',
          },
          sortName: {
            value: 'avgPre',
            type: 'string',
            required: true,
            desc: '排序字段',
          },
          sort: {
            value: 'DESC',
            type: 'string',
            required: true,
            desc: '排序方式',
          },
        },
      }

      const _request = (_params) => {
        const params = {
          endDay: '',
          endMon: '',
          page: 1,
          preType: '08-08',
          requestType: 'city',
          searcheTypes: ['sumPre'],
          size: 60,
          sizeLength: 15,
          staType: 'countrySta',
          tempThreshold1: 35,
          timeOption: 'hour',
          windThreshold1: 10.8,
          ..._params,
        }
        fetch(apiInfo.url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Accept: 'application/json',
          },
          body: JSON.stringify(params),
        })
          .then((res) => res.json())
          .then((res) => {
            if (res.code === 200) {
              if (window.postResult) {
                window.postResult(res)
              }
              let { data } = res
              let list = data.list || []
              let xAxis = [],
                yAxis = []
              for (let i = 1; i < list.length; i++) {
                xAxis.push(list[i].city)
                yAxis.push(Number(list[i].avgPre))
              }
              let time = `（${dayjs(params.startTime).format('MM') || '-'}月${dayjs(params.startTime).format('DD') || '-'}日${dayjs(params.startTime).format('HH') || ''}时~${dayjs(params.endTime).format('MM') || '-'}月${dayjs(params.endTime).format('DD') || '-'}日${dayjs(params.endTime).format('HH') || '-'}时）`
              option.title.text = `平均降水区域统计图${time}`
              option.xAxis.data = xAxis
              option.series = [
                {
                  data: yAxis,
                  type: 'bar',
                  label: {
                    show: true, // 开启显示标签
                    position: 'top', // 设置标签显示在柱子的顶部
                    textStyle: {
                      // 设置标签的样式
                      color: '#000', // 标签字体颜色
                      fontSize: 12, // 标签字体大小
                    },
                  },
                },
                {
                  name: '平均值',
                  type: 'line',
                  symbol: 'none',
                  itemStyle: { borderColor: 'none' },
                  markLine: {
                    data: [{ type: 'average', name: '平均值' }],
                    symbol: ['none', 'none'],
                    position: 'startTopCenter',
                    itemStyle: {
                      normal: {
                        lineStyle: {
                          type: 'soild',
                          width: 2,
                          color: '#91CC75',
                        },
                        label: {
                          show: true,
                          position: 'end',
                          fontSize: 10,
                          color: '#000',
                          formatter: function (params) {
                            return `${params.name}: ${params.value}`
                          },
                        },
                      },
                    },
                    large: true,
                    effect: {
                      show: false,
                      loop: true,
                      period: 0,
                      scaleSize: 2,
                      color: null,
                      shadowColor: null,
                      shadowBlur: null,
                    },
                  },
                  data: [list[0].avgPre],
                },
              ]
              chart.setOption(option)
              chart.resize()
            }
          })
      }
      function initEchart() {
        option = {
          title: {
            left: 'center',
            top: '2%',
            text: '',
            color: '#333',
            fontSize: '16',
            subtextStyle: {
              color: '#90979c',
              fontSize: '16',
            },
          },
          color: ['#335cce'],
          tooltip: {
            trigger: 'axis',
            fontSize: 14,
            formatter: function (params, ticket, callback) {
              return ` ${params[0].name}: <span style='color:#335cce;font-weight:bold'>${params[0].value}</span> mm`
            },
            textStyle: {
              color: '#000',
              fontSize: 14,
              fontFamily: 'MicrosoftYaHei',
            },
          },
          grid: {
            top: '15%',
            left: '6%',
            right: '10%',
            bottom: 30,
            containLabel: true, //包括文本，居中
          },
          xAxis: {
            type: 'category',
            data: [],
            axisLabel: {
              margin: 10,
              textStyle: {
                fontSize: 14,
              },
            },
            axisLine: {
              lineStyle: {
                color: '#477AA5',
              },
            },
            axisTick: {
              show: false,
            },
            splitLine: {
              show: false,
            },
          },
          yAxis: {
            name: '平均降水量(mm)',
            type: 'value',
            splitNumber: 7,
            axisLine: { show: true },
            axisTick: { show: true },
            splitLine: {
              show: true,
              lineStyle: {
                type: 'dashed',
                color: '#000',
              },
            },
            axisLabel: {
              margin: 10,
              textStyle: {
                color: '#000',
              },
            },
          },
          series: [],
        }
        const dom = document.getElementById('Echart')
        chart = echarts.init(dom)
      }
      window.onload = function () {
        initEchart()
        let apiArgs = apiInfo.args
        let params = {}
        for (let key in apiArgs) {
          params[key] = apiArgs[key].value
        }
        onRun(params)
        window.addEventListener('resize', () => {
          chart?.resize()
        })
      }
      function onRun(params) {
        _request(params)
      }
    </script>
    <script type="text/javascript" src="/libs/message.js"></script>
  </body>
</html>
